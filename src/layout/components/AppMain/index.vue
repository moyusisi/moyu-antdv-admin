<template>
  <div class="admin-ui-main">
    <router-view v-slot="{ Component, route }">
      <keep-alive :include="cachedViews">
        <component :is="currentComponent(Component, route)" :key="route.name"/>
      </keep-alive>
    </router-view>
    <iframe-view/>
  </div>
</template>

<script setup lang="ts">
import IframeView from "./iframeView.vue"
import Error404 from "@/views/other/404.vue"
import { useTagsViewStore } from "@/store"

// 缓存页面集合, 直接解构store中的同名字段
const { cachedViews } = toRefs(useTagsViewStore());

// 当前组件 keep-alive通过组件的name匹配,而不是route的name
const wrapperMap = new Map<string, Component>();
const currentComponent = (component: Component, route: RouteLocationNormalized) => {
  if (!component) return;
  // 使用路由的name作为组件名称
  const { name: componentName } = route;
  let wrapper = wrapperMap.get(componentName);
  // 对组件进行包装
  if (!wrapper) {
    wrapper = {
      name: componentName,
      render: () => {
        try {
          return h(component);
        } catch (error) {
          console.error(`Error rendering component for route: ${componentName}`, error);
          return h(Error404);
        }
      },
    };
    wrapperMap.set(componentName, wrapper);
  }

  // 添加组件数量限制
  if (wrapperMap.size > 100) {
    const firstKey = wrapperMap.keys().next().value;
    if (firstKey) {
      wrapperMap.delete(firstKey);
    }
  }
  return h(wrapper);
}

</script>

<style scoped>

</style>
